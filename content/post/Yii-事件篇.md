---
title: Yii-事件篇
date: 2017-09-21 23:32:23
---

最近看到一篇 [越过长城，走向世界！中国第一封 Email 发出 30 年](http://mp.weixin.qq.com/s/0M7pmESV0EJmTkd5FXCQVg)，感慨这些先驱者们的同时，内心使命感也涌涌而上。之前也没配置过相关邮件服务，遂打算以此文来纪录学习一番。

![](https://ws3.sinaimg.cn/large/006tNc79gy1fjro4d2a9rj30go0bc75r.jpg)

<!--more-->

那么如何让用户注册账号时触发一个发送邮件的事件呢? 现在很多框架都继承了邮件的功能，遍地的轮子啊！（本篇使用Yii2框架来了解事件如何定义及如何触发并实现发送邮件功能）


- 配置参数

- 发送邮件的组件类

- 通过Ioc容器来传递事件参数

- 业务中触发发送邮件事件


### 配置参数

在 `common/config/main-local.php` 文件中已有 `mailer`的一个简单配置，添加服务端邮件信息即可，配置如下：

```php
'mailer' => [
  'class'            => 'yii\swiftmailer\Mailer',
  'viewPath'         => '@common/mail',
  // false发送邮件，true只是生成邮件在runtime文件夹下，不发邮件
  'useFileTransport' => false,
  'transport'        => [
    'class'      => 'Swift_SmtpTransport',
    // 163,gmail等邮箱注意更改
    'host'       => 'smtp.qq.com',
    // 登录用户名
    'username'   => 'surprisepeas@qq.com',
    // 需要注意的是:如果是QQ邮箱,需要去邮箱设置里获取授权码
    'password'   => 'qnrrfovxvsvmgade',
    'port'       => '25',
    // 加密算法
    'encryption' => 'tls',
  ],
  'messageConfig'    => [
    'charset' => 'UTF-8',
    // 发送者名称抬头 必须与username配置一致
    'from'    => ['surprisepeas@qq.com' => 'Zachary'],
  ],
],
```

> QQ邮件password获取授权码

![](https://ws4.sinaimg.cn/large/006tNc79gy1fjro9y0z9oj31ck0g2gq6.jpg)

### 创建邮件组件类

Yii内自带了Mailer组件，只需要根据自己业务传递相应参数即可。我们这边在`backend\components`目录下新建一个**mail**的发送组件，页面元素亦可在 `common\mail`下自定义。

```php
<?php namespace backend\components;

use Yii;

class Mail
{
    public static function sendMail($event)
    {
        return Yii::$app->mailer->compose()
            // 接收的邮箱地址
            ->setTo($event->email)
          	// 邮件标题
            ->setSubject($event->subject)
          	// 纯文本内容
            ->setTextBody($event->content)
          	// HTML内容
            ->setHtmlBody('<b>HTML content</b>')
          	// 发送
            ->send();
    }
}
```

### 定义传递参数(控制反转容器)

   ```php
<?php namespace app\components\event;

use yii\base\Event;

class MailEvent extends Event
{
  public $email;
  public $subject;
  public $content;
  public $body;
}
   ```


### 触发发送邮件事件

业务代码中... `app\controllers\EventController`

```php
<?php namespace app\controllers;

use app\components\event\MailEvent;
use yii\web\Controller;
use Yii;

class EventController extends Controller
{
  
  const SEND_MAIL = 'send_mail';
  
  // 在初始化中绑定事件
  public function init()
  {
        parent::init(); // TODO: Change the autogenerated stub
    
    	// 首先得绑定一个事件 params: 触发事件名, 组件类, 方法
        $this->on(self::SEND_MAIL,['app\components\Mail', 'sendMail']);
  }
  
    public function actionRegister() 
    {
        // code...
	    $email = '1027132125@qq.com';
        $subject = 'Hi man,this\'s title ';
        $content = 'Hello';
        $body = '<b>Zachary send second email</b>';
      	$this->sendMail($email,$subject,$body);
      
      	return '已发送邮件..balabala';
    }
 
  	// 触发事件
    public function sendMail($email,$subject,$body)
    {
        $event = new MailEvent();
        $event->email = $email;
        $event->subject = $subject;
        $event->body = $body;
        $event->content = 'Hello';
		
        $this->trigger(self::SEND_MAIL, $event);
    }
  
}
```





   ​

